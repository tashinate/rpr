const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-JvkOvjRC.js","assets/index-C_mq_8cL.css"])))=>i.map(i=>d[i]);
var w=Object.defineProperty;var y=(g,e,t)=>e in g?w(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var U=(g,e,t)=>y(g,typeof e!="symbol"?e+"":e,t);import{_ as S,s as o}from"./index-JvkOvjRC.js";class A{constructor(){U(this,"agedUrls",new Map);U(this,"reputationMetrics",new Map)}async preGenerateUrls(e,t,a,r={}){const{agingPeriod:s=168,maxUsage:n=100,batchSize:i=10,reputationBuilding:u=!0,preWarmTraffic:d=!0}=r,_=[];for(let c=0;c<i;c++){const{centralizedUrlProcessor:p}=await S(async()=>{const{centralizedUrlProcessor:m}=await import("./index-JvkOvjRC.js").then(h=>h.c);return{centralizedUrlProcessor:m}},__vite__mapDeps([0,1])),f=await p.generateUnifiedUrl(e,t,{pattern:a,varietySeed:c}),l={id:this.generateUrlId(),url:f.url,originalUrl:e,licenseKeyId:t,pattern:a,createdAt:new Date,usageCount:0,reputationScore:50,status:"aging",agingPeriod:s,maxUsage:n,metadata:{...f.metadata,batchIndex:c,preWarmTraffic:d,reputationBuilding:u}};this.agedUrls.set(l.id,l),await this.storeAgedUrl(l),this.reputationMetrics.set(l.id,{deliveryRate:0,clickRate:0,spamReports:0,bounceRate:0,trustScore:50,lastUpdated:new Date}),_.push(l),u&&this.startReputationBuilding(l)}return console.log(`âœ… Pre-generated ${i} URLs for aging`),_}async getAgedUrl(e,t,a){const r=Array.from(this.agedUrls.values()).filter(d=>d.originalUrl===e&&d.licenseKeyId===t&&d.status==="ready"&&d.usageCount<d.maxUsage&&(!a||d.pattern===a));if(r.length>0){r.sort((_,c)=>{const p=c.reputationScore-_.reputationScore;return p!==0?p:c.createdAt.getTime()-_.createdAt.getTime()});const d=r[0];return await this.markUrlAsUsed(d.id),d}const{data:s,error:n}=await o.from("aged_urls").select("*").eq("original_url",e).eq("license_key_id",t).eq("status","ready").lt("usage_count","max_usage").order("reputation_score",{ascending:!1}).order("created_at",{ascending:!0}).limit(1);if(n||!s||s.length===0)return null;const i=s[0],u={id:i.id,url:i.url,originalUrl:i.original_url,licenseKeyId:i.license_key_id,pattern:i.pattern,createdAt:new Date(i.created_at),firstUsedAt:i.first_used_at?new Date(i.first_used_at):void 0,lastUsedAt:i.last_used_at?new Date(i.last_used_at):void 0,usageCount:i.usage_count,reputationScore:i.reputation_score,status:i.status,agingPeriod:i.aging_period,maxUsage:i.max_usage,metadata:i.metadata||{}};return this.agedUrls.set(u.id,u),await this.markUrlAsUsed(u.id),u}async markUrlAsUsed(e){var a;const t=this.agedUrls.get(e);t&&(t.usageCount++,t.lastUsedAt=new Date,t.firstUsedAt||(t.firstUsedAt=new Date,t.status="active"),await o.from("aged_urls").update({usage_count:t.usageCount,last_used_at:t.lastUsedAt.toISOString(),first_used_at:(a=t.firstUsedAt)==null?void 0:a.toISOString(),status:t.status}).eq("id",e),t.usageCount>=t.maxUsage&&await this.burnUrl(e))}async updateReputationMetrics(e,t){const a=this.reputationMetrics.get(e);if(!a)return;const r={...a,...t,lastUpdated:new Date};r.trustScore=this.calculateTrustScore(r),this.reputationMetrics.set(e,r);const s=this.agedUrls.get(e);s&&(s.reputationScore=r.trustScore,await o.from("aged_urls").update({reputation_score:s.reputationScore}).eq("id",e)),await o.from("url_reputation_metrics").upsert({url_id:e,delivery_rate:r.deliveryRate,click_rate:r.clickRate,spam_reports:r.spamReports,bounce_rate:r.bounceRate,trust_score:r.trustScore,last_updated:r.lastUpdated.toISOString()})}async processAgingQueue(){const e=new Date;for(const[r,s]of this.agedUrls.entries())if(s.status==="aging"){const n=(e.getTime()-s.createdAt.getTime())/36e5;n>=s.agingPeriod&&(s.status="ready",await o.from("aged_urls").update({status:"ready"}).eq("id",r),console.log(`âœ… URL ${r} is now ready for use after ${n.toFixed(1)} hours of aging`))}const{data:t,error:a}=await o.from("aged_urls").select("*").eq("status","aging").lt("created_at",new Date(e.getTime()-24*60*60*1e3).toISOString());if(!a&&t)for(const r of t){const s=new Date(r.created_at);(e.getTime()-s.getTime())/(1e3*60*60)>=r.aging_period&&await o.from("aged_urls").update({status:"ready"}).eq("id",r.id)}}async burnUrl(e){const t=this.agedUrls.get(e);t&&(t.status="burned",await o.from("aged_urls").update({status:"burned"}).eq("id",e),console.log(`ðŸ”¥ URL ${e} has been burned due to overuse`))}async cleanupExpiredUrls(){const e=new Date;e.setDate(e.getDate()-30);for(const[t,a]of this.agedUrls.entries())a.createdAt<e&&(this.agedUrls.delete(t),this.reputationMetrics.delete(t));await o.from("aged_urls").update({status:"expired"}).lt("created_at",e.toISOString()).neq("status","expired"),console.log("ðŸ§¹ Cleaned up URLs older than 30 days")}async getAgingStatistics(){const{data:e,error:t}=await o.from("aged_urls").select("status, reputation_score");if(t||!e)return{total:0,aging:0,ready:0,active:0,burned:0,expired:0,averageReputationScore:0};const a=e.reduce((s,n)=>(s[n.status]=(s[n.status]||0)+1,s),{}),r=e.length>0?e.reduce((s,n)=>s+n.reputation_score,0)/e.length:0;return{total:e.length,aging:a.aging||0,ready:a.ready||0,active:a.active||0,burned:a.burned||0,expired:a.expired||0,averageReputationScore:Math.round(r)}}async startReputationBuilding(e){setTimeout(async()=>{const t=this.reputationMetrics.get(e.id);t&&await this.updateReputationMetrics(e.id,{deliveryRate:Math.min(95,t.deliveryRate+Math.random()*10),trustScore:Math.min(90,t.trustScore+Math.random()*5)})},Math.random()*36e5)}calculateTrustScore(e){let t=50;return t+=(e.deliveryRate-50)*.4,t+=(e.clickRate-5)*4,t-=e.spamReports*10,t-=e.bounceRate*.5,Math.max(0,Math.min(100,t))}async storeAgedUrl(e){await o.from("aged_urls").insert({id:e.id,url:e.url,original_url:e.originalUrl,license_key_id:e.licenseKeyId,pattern:e.pattern,created_at:e.createdAt.toISOString(),usage_count:e.usageCount,reputation_score:e.reputationScore,status:e.status,aging_period:e.agingPeriod,max_usage:e.maxUsage,metadata:e.metadata})}generateUrlId(){return`aged_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}async initialize(){const{data:e,error:t}=await o.from("aged_urls").select("*").in("status",["aging","ready","active"]).order("created_at",{ascending:!1}).limit(1e3);if(!t&&e)for(const a of e){const r={id:a.id,url:a.url,originalUrl:a.original_url,licenseKeyId:a.license_key_id,pattern:a.pattern,createdAt:new Date(a.created_at),firstUsedAt:a.first_used_at?new Date(a.first_used_at):void 0,lastUsedAt:a.last_used_at?new Date(a.last_used_at):void 0,usageCount:a.usage_count,reputationScore:a.reputation_score,status:a.status,agingPeriod:a.aging_period,maxUsage:a.max_usage,metadata:a.metadata||{}};this.agedUrls.set(r.id,r)}console.log(`ðŸ“Š Loaded ${this.agedUrls.size} aged URLs from database`)}startBackgroundProcesses(){setInterval(()=>{this.processAgingQueue().catch(console.error)},36e5),setInterval(()=>{this.cleanupExpiredUrls().catch(console.error)},864e5),console.log("ðŸ”„ Started URL aging background processes")}}const b=new A;export{A as UrlAgingService,b as urlAging};
